#ZFS tools

-------------------------

*Support development of this software. [Donate to 1Cw9nZu9ygknussPofMWCzmSMveusTbQvN](bitcoin:1Cw9nZu9ygknussPofMWCzmSMveusTbQvN)*

<img width="164" height="164" title="" alt="" src="data:image/png;base64,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" />

-------------------------

The ZFS backup tools will help you graft an entire ZFS pool as a filesystem
into a backup machine, without having to screw around snapshot names or
complicated shell commands or crontabs.

The utilities let you do this:

1. zfs-shell:  
   a shell that allows remote ZFS administration and nothing more

2. zmirror:  
   a command that snapshots a dataset or pool, then sends the snapshots,
   dataset by dataset, to another machine, without using replication streams.
   It will delete obsolete snapshots on the source and destination machines,
   keeping a maximum of one snapshot tree on each machine.  It will not
   delete snapshots indiscriminately, though -- it will only delete snapshots
   prefixed with zmirror-.

3. zsnap:  
   a command that snapshots a dataset or pool, then deletes old snapshots

4. zreplicate  
   a command that replicates an entire dataset tree using ZFS replication
   streams.  Best used in combination with zsnap as in:
   
   - zsnap on the local machine
   - zreplicate from the local machine to the destination machine

   Obsolete snapshots deleted by zsnap will be automatically purged on
   the destination machine by zreplicate.
   
   Run `zreplicate --help` for a compendium of options you may use.

The repository, bug tracker and Web site for this tool is at [http://github.com/Rudd-O/zfs-tools](http://github.com/Rudd-O/zfs-tools).  Comments to me through rudd-o@rudd-o.com.

##Setting up

Setup is rather complicated.  It assumes that you already have ZFS running
and vaults on both the machine you're going to back up and the machine that
will be receiving the backup.

###On the machine to back up

- Install the zfs-shell command   
  `cp zfs-shell /usr/local/sbin`  
  `chmod 755 /usr/local/sbin/zfs-shell`  
  `chown root.root /usr/local/sbin/zfs-shell`  

- Create a user with a home directory and shell `zfs-shell`  
  `useradd -rUm -b /var/lib -s /usr/local/sbin/zfs-shell zfs`

- Let `sudo` know that the new user can run the zfs command  
  `zfs ALL = NOPASSWD: /usr/local/sbin/zfs`  
  (ensure you remove the `requiretty` default on `/etc/sudoers`)

- Set up a cron job to run `zsnap` as frequently as you want to,
  snapshotting the dataset you intend to replicate.

###On the backup machine

- Set up public key authentication for SSH so the backup machine
  may log as the user `zfs` (as laid out above) in the machine to
  be backed up.

- Create a dataset to receive the backup stream.

- Set up a cron job to fetch the dataset snapshotted by zsnap
  from the remote machine into the newly created dataset.  You
  will use `zreplicate` for that (see below for examples).

- After the first replication, you may want to set the `mountpoint`
  attributes on the received datasets so they do not automount
  on the backup machine.

###Test

If all went well, you should be able to do this without issue:

(on the machine to back up)

    [root@peter]
    zsnap senderpool

(on the machine to receive)

    [root@paul]
    zfs create receiverpool/senderpool # <--- run this ONLY ONCE
    zreplicate -o zfs@paul:senderpool receiverpool/senderpool
    # this should send the entire senderpool with all snapshots
    # over from peter to paul, placing it in receiverpool/senderpool

(on the machine to back up)

    [root@peter]
    zsnap senderpool

(on the machine to receive)

    [root@paul]
    zreplicate -o zfs@paul:senderpool receiverpool/senderpool
    # this should send an incremental stream of senderpool
    # into receiverpool/senderpool

And that's it, really.

##zmirror

Zmirror is an useful command that does not replicate a dataset tree and
all of its snapshots, but rather only replicates dataset by dataset
(still recursively, but breaking the logical references between datasets)
and only keeps the latest snapshot.  This can be useful in the case that
you do not have as much disk space on the receiving pool as you have on
the source pool.  It, however, will not respect deduplication, clones or
copy-on-write, so there's that.  It is old code that I was using before
I figured out how to effectively use replication streams in lieu of simple
dataset sends and receives.
