The ZFS backup tools will help you graft an entire ZFS pool as a filesystem
into a backup machine, every day.  Two utilities do this:

1. zfs-shell:
   a shell that allows remote ZFS administration

2. zfs-fetch-pool:
   a command that snapshots, then fetches a pool from a machine with zfs-shell

What they actually do is rather simple:

- zfs-fetch-pool remotely snapshots the pool on the machine with zfs-shell
- then, zfs-fetch-pool fetches the snapshot incrementally from the machine
- finally, zfs-fetch-pool removes old snapshots it created earlier for its use

*** Setting up ***

Setup is rather complicated.  It assumes that you already have ZFS running
and vaults on both the machine you're going to back up and the machine that
will be receiving the backup.

*** On the machine to back up ***

- Install the zfs-shell command
  cp zfs-shell /usr/local/sbin
  chmod 755 /usr/local/sbin/zfs-shell
  chown root.root /usr/local/sbin/zfs-shell

- Create a user with a home directory and shell zfs-shell
  useradd -rUm -b /var/lib -s /usr/local/sbin/zfs-shell zfs

- Let sudo know that the new user can run the zfs command
  zfs ALL = NOPASSWD: /usr/local/sbin/zfs
  (ensure you remove the requiretty default on /etc/sudoers)

*** On the backup machine ***

- Install zfs-fetch-pool
  cp zfs-fetch-pool /usr/local/sbin
  chmod 755 /usr/local/sbin/zfs-fetch-pool
  chown root.root /usr/local/sbin/zfs-fetch-pool

*** Set up authentication ***

Now you need to set authentication up.  The goal is to let the backup machine
connect as the newly created user in the machine to back up.

If you're going to use SSH, your best bet is to:

- enable PubkeyAuthentication in the machine to back up,
- generate a private/public key pair for the root user of the backup machine
- add the public key into the newly created user of the machine to back up,
- connect from the root user in the backup machine to the newly created
  user in the machine to back up (at least one time), to
  guarantee that the public key of the machine to back up is
  registered into the root user's keyring of the backup machine.

But you could also use RSH (it's much higher-performance in local networks).

Whatever you choose, there are fine tutorials around the Web for this.
Google is your friend.

*** Test ***

If all went well, you should be able to run one of these two commands from
the backup machine just fine (assuming that the new user is zfs):

- rsh -l zfs machine-to-back-up list
- ssh -l zfs machine-to-back-up list

And that should list the ZFS filesystems currently in the backup machine.

*** Run ***

Running it is rather simple.  Let's assume the following for an example:

- Machine to back up: karen
- New user on that machine: zfs
- Connection method: RSH
- Vault to back up: tank
- Vault to receive tank in the backup machine: backupvault

The command you need to run as root on the backup machine is:

    zfs-fetch-vault rsh://karen@gabriela/tank vault

If you're using SSH you can omit the rsh:// part.

*** The end ***

And that's it, really.  Put your zfs-fetch-vault into a crontab so it gets
executed daily, and everything should be great!

Comments to me through rudd-o@rudd-o.com.

